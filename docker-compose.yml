version: '2.3'

services:

  xvfbsrv:
    image: launchkart
    ports:
      - "6000:6000"
    entrypoint: [
      'Xvfb', ':0',
      '-screen', '0',
      '640x480x24',
      '-fbdir', '/dev/shm', # Framebuffer to use shared memory
      '-ac', # Disable access control - enables access by any host (https://www.x.org/archive/X11R6.8.1/doc/Xserver.1.html)
      '-listen', 'tcp' # Allow remote connections over TCP
    ]


  vncsrv:
    image: launchkart
    environment:
      - DISPLAY=xvfbsrv:0
    ports:
      - "5900:5900"
    entrypoint: [ 'x11vnc', '-forever', '-viewonly', '-shared', '-nopw', '-noshm' ]
    depends_on: [ xvfbsrv ]


  emulator:
    image: launchkart
    environment:
      - DISPLAY=xvfbsrv:0
    command: [
      'mupen64plus',
      '--nospeedlimit',
      '--nosaveoptions',
      '--resolution', '640x480',
      '--gfx', 'mupen64plus-video-glide64.so',
      '--audio', 'dummy',
      '--input', '/usr/local/lib/mupen64plus/mupen64plus-input-bot.so',
      '--set', 'Input-Bot-Control0[plugged]=1',
      '--set', 'Input-Bot-Control0[host]=agent',
      '--set', 'Input-Bot-Control0[port]=8082',
      '/src/gym-mupen64plus/gym_mupen64plus/ROMs/marioKart.n64'
    ]
    depends_on: [ xvfbsrv, agent ]


  agent:
    image: launchkart
    environment:
      - DISPLAY=xvfbsrv:0
      - EXTERNAL_EMULATOR=True
    volumes:
      # - type: bind
      #   source: "$PWD" 
      #   target: /src/launchkart
      - ./:/src/launchkart
    command: [ 'python3', '-u', "/src/launchkart/env_test.py" ] # -u for unbuffered output so logs show immediately (in theory)
    # command: ['python3', '-u', '/src/launchkart/ppo_baseline.py']
    depends_on: [ xvfbsrv ]


# version: '3.5'
# services:
#   head:
#     image: launchkart
#     shm_size: 8gb
#     ports:
#       - 8265:8265
#       - 6006:6006
#     networks:
#       - ray-network
#     volumes:
#       - type: bind
#         source: "$PWD" 
#         target: /src/launchkart
#       - ./ray_results:/root/ray_results
#     entrypoint:
#       'bash -c "ray start --head --dashboard-host 0.0.0.0 --port=6379 --num-cpus 1 --num-gpus 0 && tensorboard --logdir ~/ray_results --bind_all & python3 -u /src/launchkart/ppo_train.py --environment Mario-Kart-Discrete-Choco-Mountain-v0 --workers 1 --gpus 0 --checkpoint /src/launchkart/ray_results/PPO/PPO_mario_kart_choco_mountain_aa843_00000_0_2022-02-01_17-52-04/checkpoint_000001/checkpoint-1"'

#   agent:
#     image: launchkart
#     shm_size: 8gb
#     depends_on:
#       - head
#     ports:
#       - 5900-5916:5900
#     networks:
#       - ray-network
#     volumes:
#       - ./ray_results:/root/ray_results
#     entrypoint:
#       'bash -c "ray start --address=head:6379 --redis-password=5241590000000000 --num-cpus 1 --num-gpus 0 --block & until ps aux | grep -i "[x]vfb" > /dev/null; do sleep 1; done && x11vnc -forever -viewonly -shared -nopw -noshm"'
  
#   xvfbsrv:
#     image: launchkart
#     ports:
#       - "6000:6000"
#     entrypoint: [
#       'Xvfb', ':0',
#       '-screen', '0',
#       '640x480x24',
#       '-fbdir', '/dev/shm', # Framebuffer to use shared memory
#       '-ac', # Disable access control - enables access by any host (https://www.x.org/archive/X11R6.8.1/doc/Xserver.1.html)
#       '-listen', 'tcp' # Allow remote connections over TCP
#     ]

#   vncsrv:
#     image: launchkart
#     environment:
#       - DISPLAY=xvfbsrv:0
#     ports:
#       - "5900:5900"
#     entrypoint: [ 'x11vnc', '-forever', '-viewonly', '-shared', '-nopw', '-noshm' ]

# networks:
#   ray-network:
#     driver: bridge